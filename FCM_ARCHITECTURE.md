# FCM ì„œë²„ í‘¸ì‹œ ì•Œë¦¼ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## ì „ì²´ êµ¬ì¡°ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ìŠ¤ì¼€ì¤„ë§ ë ˆì´ì–´                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  GitHub Actions (daily-nudge.yml)                                    â”‚   â”‚
â”‚  â”‚  - ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST) = UTC 00:00                                   â”‚   â”‚
â”‚  â”‚  - ë§¤ì¼ ì˜¤í›„ 9ì‹œ (KST) = UTC 12:00                                   â”‚   â”‚
â”‚  â”‚  â†’ send-batch-nudge Edge Function í˜¸ì¶œ                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Supabase Edge Functions                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  send-batch-nudge  â”‚  â”‚  send-smart-nudge  â”‚  â”‚   send-fcm-push    â”‚    â”‚
â”‚  â”‚  (ë°°ì¹˜ ì²˜ë¦¬)        â”‚  â”‚  (ê°œë³„ ì‚¬ìš©ì)      â”‚  â”‚   (ì§ì ‘ í‘¸ì‹œ)       â”‚    â”‚
â”‚  â”‚                    â”‚  â”‚                    â”‚  â”‚                    â”‚    â”‚
â”‚  â”‚  ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ    â”‚  â”‚  íŠ¹ì • ì‚¬ìš©ìì˜      â”‚  â”‚  ë‹¨ìˆœ í‘¸ì‹œ ì „ì†¡     â”‚    â”‚
â”‚  â”‚  â†’ ê° ì‚¬ìš©ìë³„      â”‚  â”‚  ë…ì„œ ìƒíƒœ ë¶„ì„     â”‚  â”‚  (í…ŒìŠ¤íŠ¸/ìˆ˜ë™ìš©)    â”‚    â”‚
â”‚  â”‚    ë„›ì§€ ë¶„ì„        â”‚  â”‚  â†’ ë§ì¶¤ ì•Œë¦¼ ìƒì„±   â”‚  â”‚                    â”‚    â”‚
â”‚  â”‚  â†’ FCM í‘¸ì‹œ ì „ì†¡    â”‚  â”‚  â†’ FCM í‘¸ì‹œ ì „ì†¡    â”‚  â”‚                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â”‚                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â–¼                                   â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    FCM HTTP v1 API ì¸ì¦                              â”‚   â”‚
â”‚  â”‚  - Firebase Service Account JSON (FIREBASE_SERVICE_ACCOUNT)         â”‚   â”‚
â”‚  â”‚  - OAuth 2.0 JWT ìƒì„± â†’ Access Token íšë“                           â”‚   â”‚
â”‚  â”‚  - í† í° ìºì‹± (1ì‹œê°„)                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Firebase Cloud Messaging                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FCM HTTP v1 API                                                     â”‚   â”‚
â”‚  â”‚  POST https://fcm.googleapis.com/v1/projects/{project}/messages:send â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  ë©”ì‹œì§€ êµ¬ì¡°:                                                        â”‚   â”‚
â”‚  â”‚  {                                                                   â”‚   â”‚
â”‚  â”‚    "message": {                                                      â”‚   â”‚
â”‚  â”‚      "token": "ë””ë°”ì´ìŠ¤ FCM í† í°",                                   â”‚   â”‚
â”‚  â”‚      "notification": { "title": "...", "body": "..." },             â”‚   â”‚
â”‚  â”‚      "data": { "bookId": "...", "nudgeType": "..." }                â”‚   â”‚
â”‚  â”‚    }                                                                 â”‚   â”‚
â”‚  â”‚  }                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Flutter ì•± (í´ë¼ì´ì–¸íŠ¸)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FCMService (fcm_service.dart)                                       â”‚   â”‚
â”‚  â”‚  - FCM í† í° ë°œê¸‰ ë° Supabaseì— ì €ì¥                                  â”‚   â”‚
â”‚  â”‚  - í¬ê·¸ë¼ìš´ë“œ/ë°±ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹                                   â”‚   â”‚
â”‚  â”‚  - ë¡œì»¬ ì•Œë¦¼ í‘œì‹œ                                                    â”‚   â”‚
â”‚  â”‚  - ì•Œë¦¼ íƒ­ ì‹œ payload íŒŒì‹± â†’ ì½œë°± í˜¸ì¶œ                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MainScreen (main.dart)                                              â”‚   â”‚
â”‚  â”‚  - onNotificationTap ì½œë°± ë“±ë¡                                       â”‚   â”‚
â”‚  â”‚  - payloadì—ì„œ bookId ì¶”ì¶œ                                           â”‚   â”‚
â”‚  â”‚  - bookId ìˆìœ¼ë©´ í•´ë‹¹ ì±…, ì—†ìœ¼ë©´ í˜„ì¬ ì½ëŠ” ì±… ì¡°íšŒ                    â”‚   â”‚
â”‚  â”‚  - BookDetailScreenRedesignedë¡œ ì´ë™                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. ë°ì´í„°ë² ì´ìŠ¤ (Supabase)

### fcm_tokens í…Œì´ë¸”
```sql
CREATE TABLE fcm_tokens (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  token TEXT NOT NULL,           -- FCM ë””ë°”ì´ìŠ¤ í† í°
  device_type TEXT,              -- 'ios', 'android', 'web'
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
);
```

**ì—­í• :** ì‚¬ìš©ìë³„ FCM í† í° ì €ì¥. ì„œë²„ì—ì„œ í‘¸ì‹œë¥¼ ë³´ë‚¼ ë•Œ ì´ í…Œì´ë¸”ì—ì„œ í† í° ì¡°íšŒ.

---

## 2. Edge Functions (ì„œë²„)

### 2-1. send-fcm-push
**ìœ„ì¹˜:** `supabase/functions/send-fcm-push/index.ts`

**ìš©ë„:** ë‹¨ìˆœ í‘¸ì‹œ ì „ì†¡ (í…ŒìŠ¤íŠ¸/ìˆ˜ë™)

**ì…ë ¥:**
```json
{
  "userId": "ì‚¬ìš©ì UUID",
  "title": "ì•Œë¦¼ ì œëª©",
  "body": "ì•Œë¦¼ ë‚´ìš©",
  "data": { "key": "value" }
}
```

**ë™ì‘:**
1. userIdë¡œ fcm_tokens í…Œì´ë¸”ì—ì„œ í† í° ì¡°íšŒ
2. FCM v1 APIë¡œ í‘¸ì‹œ ì „ì†¡

---

### 2-2. send-smart-nudge
**ìœ„ì¹˜:** `supabase/functions/send-smart-nudge/index.ts`

**ìš©ë„:** ê°œë³„ ì‚¬ìš©ì ë§ì¶¤ ë„›ì§€ ì „ì†¡

**ì…ë ¥:**
```json
{
  "userId": "ì‚¬ìš©ì UUID",
  "forceType": "streak"
}
```

**ë™ì‘:**
1. ì‚¬ìš©ìì˜ ë…ì„œ ë°ì´í„° ë¶„ì„ (`analyzeUserReadingState`)
2. ë„›ì§€ íƒ€ì… ê²°ì • (ìš°ì„ ìˆœìœ„):
   - **inactive**: 3ì¼ ì´ìƒ ë…ì„œ ì•ˆ í•¨
   - **deadline**: ëª©í‘œì¼ê¹Œì§€ 3ì¼ ì´ë‚´
   - **progress**: 80% ì´ìƒ ì§„í–‰
   - **streak**: 1-7ì¼ ì—°ì† ë…ì„œ ì¤‘
3. ë§ì¶¤ ë©”ì‹œì§€ ìƒì„±
4. FCM í‘¸ì‹œ ì „ì†¡ (bookId í¬í•¨)

---

### 2-3. send-batch-nudge
**ìœ„ì¹˜:** `supabase/functions/send-batch-nudge/index.ts`

**ìš©ë„:** ì „ì²´ ì‚¬ìš©ì ì¼ê´„ ë„›ì§€ ì „ì†¡ (ìŠ¤ì¼€ì¤„ëŸ¬ìš©)

**ì…ë ¥:** ì—†ìŒ (POST ìš”ì²­ë§Œ)

**ë™ì‘:**
1. fcm_tokens í…Œì´ë¸”ì—ì„œ ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ
2. ê° ì‚¬ìš©ìë³„ë¡œ `analyzeUserReadingState` ì‹¤í–‰
3. ì¡°ê±´ì— ë§ëŠ” ì‚¬ìš©ìì—ê²Œë§Œ í‘¸ì‹œ ì „ì†¡
4. ë¬´íš¨í•œ í† í° ìë™ ì‚­ì œ

**ê²°ê³¼:**
```json
{
  "success": true,
  "summary": {
    "totalUsers": 10,
    "sent": 5,
    "skipped": 4,
    "failed": 1
  }
}
```

---

## 3. FCM ì¸ì¦ íë¦„

```
Service Account JSON (private_key í¬í•¨)
           â”‚
           â–¼
JWT ìƒì„± (iss: client_email, scope: fcm, ì„œëª…: RSA-SHA256)
           â”‚
           â–¼
Google OAuth 2.0 Token Endpoint (POST /token)
           â”‚
           â–¼
Access Token (1ì‹œê°„ ìœ íš¨, ìºì‹±í•˜ì—¬ ì¬ì‚¬ìš©)
```

**ì½”ë“œ ìœ„ì¹˜:** ê° Edge Functionì˜ `getAccessToken()` í•¨ìˆ˜

---

## 4. GitHub Actions ìŠ¤ì¼€ì¤„ëŸ¬

**ìœ„ì¹˜:** `.github/workflows/daily-nudge.yml`

```yaml
on:
  schedule:
    - cron: '0 0 * * *'   # UTC 00:00 = KST 09:00
    - cron: '0 12 * * *'  # UTC 12:00 = KST 21:00
  workflow_dispatch:       # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
```

**í•„ìš”í•œ GitHub Secrets:**
- `SUPABASE_URL`
- `SUPABASE_ANON_KEY`

---

## 5. Flutter ì•± (í´ë¼ì´ì–¸íŠ¸)

### 5-1. FCMService
**ìœ„ì¹˜:** `app/lib/data/services/fcm_service.dart`

| ë©”ì„œë“œ | ì—­í•  |
|--------|------|
| `initialize()` | FCM ì´ˆê¸°í™”, ê¶Œí•œ ìš”ì²­, í† í° ë°œê¸‰ |
| `saveTokenToSupabase()` | í† í°ì„ fcm_tokens í…Œì´ë¸”ì— ì €ì¥ |
| `_handleForegroundMessage()` | í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹  â†’ ë¡œì»¬ ì•Œë¦¼ í‘œì‹œ |
| `_handleNotificationTap()` | ì•Œë¦¼ íƒ­ â†’ payload íŒŒì‹± â†’ ì½œë°± í˜¸ì¶œ |
| `onNotificationTap` | ì™¸ë¶€ ì½œë°± (main.dartì—ì„œ ë“±ë¡) |

### 5-2. ì•Œë¦¼ íƒ­ â†’ ë”¥ë§í¬ íë¦„

```
ì‚¬ìš©ìê°€ ì•Œë¦¼ í„°ì¹˜
       â”‚
       â–¼
_handleNotificationTap(NotificationResponse)
       â”‚
       â”œâ”€ payload ë¬¸ìì—´ íŒŒì‹± â†’ Map<String, dynamic>
       â”‚
       â–¼
onNotificationTap(payload) ì½œë°± í˜¸ì¶œ
       â”‚
       â–¼
main.dartì˜ ì½œë°± ì‹¤í–‰
       â”‚
       â”œâ”€ bookId ìˆìŒ? â†’ í•´ë‹¹ ì±… ì¡°íšŒ
       â””â”€ bookId ì—†ìŒ? â†’ í˜„ì¬ ì½ëŠ” ì±… ì¡°íšŒ
       â”‚
       â–¼
BookDetailScreenRedesignedë¡œ Navigator.push
```

---

## 6. ìŠ¤ë§ˆíŠ¸ ë„›ì§€ ë¡œì§

### analyzeUserReadingState í•¨ìˆ˜

```
ì…ë ¥: userId
ì¶œë ¥: { type, title, body, data } ë˜ëŠ” null

1. ì‚¬ìš©ìì˜ books í…Œì´ë¸” ì¡°íšŒ (updated_at ë‚´ë¦¼ì°¨ìˆœ)

2. ë¶„ì„ í•­ëª©:
   - daysSinceLastReading: ë§ˆì§€ë§‰ ë…ì„œ í›„ ê²½ê³¼ì¼
   - progress: í˜„ì¬í˜ì´ì§€ / ì´í˜ì´ì§€
   - daysUntilDeadline: ëª©í‘œì¼ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜
   - streak: ìµœê·¼ 7ì¼ ì¤‘ ë…ì„œí•œ ì¼ìˆ˜

3. ë„›ì§€ íƒ€ì… ê²°ì • (ìš°ì„ ìˆœìœ„ìˆœ):
   - daysSinceLastReading >= 3     â†’ "inactive"
   - 0 < daysUntilDeadline <= 3    â†’ "deadline"
   - 0.8 <= progress < 1.0         â†’ "progress"
   - 0 < streak < 7                â†’ "streak"
   - ELSE                          â†’ null (ì•Œë¦¼ ì•ˆ ë³´ëƒ„)

4. ë©”ì‹œì§€:
   - inactive: "ë…ì„œë¥¼ ìŠì§€ ë§ˆì„¸ìš”! ğŸ“š"
   - deadline: "ëª©í‘œ ì™„ë£Œê¹Œì§€ ì–¼ë§ˆ ì•ˆ ë‚¨ì•˜ì–´ìš”! â°"
   - progress: "ëª©í‘œ ë‹¬ì„±ê¹Œì§€ ì¡°ê¸ˆë§Œ ë”! ğŸ¯"
   - streak: "ë…ì„œ ì—°ì†ì¼ì„ ì´ì–´ê°€ì„¸ìš”! ğŸ”¥"
```

---

## 7. íŒŒì¼ êµ¬ì¡°

```
book-golas/
â”œâ”€â”€ .github/workflows/
â”‚   â””â”€â”€ daily-nudge.yml              # ìŠ¤ì¼€ì¤„ëŸ¬
â”‚
â”œâ”€â”€ supabase/functions/
â”‚   â”œâ”€â”€ send-fcm-push/index.ts       # ë‹¨ìˆœ í‘¸ì‹œ
â”‚   â”œâ”€â”€ send-smart-nudge/index.ts    # ê°œë³„ ìŠ¤ë§ˆíŠ¸ ë„›ì§€
â”‚   â”œâ”€â”€ send-batch-nudge/index.ts    # ë°°ì¹˜ ìŠ¤ë§ˆíŠ¸ ë„›ì§€
â”‚   â””â”€â”€ deno.json                    # Deno ì„¤ì •
â”‚
â”œâ”€â”€ app/lib/
â”‚   â”œâ”€â”€ data/services/fcm_service.dart   # FCM í´ë¼ì´ì–¸íŠ¸
â”‚   â””â”€â”€ main.dart                        # ì•Œë¦¼ íƒ­ í•¸ë“¤ëŸ¬
â”‚
â”œâ”€â”€ .gitignore                       # Firebase ì„œë¹„ìŠ¤ ê³„ì • ì œì™¸
â””â”€â”€ SETUP_FCM_SERVER.md              # ì„¤ì • ê°€ì´ë“œ
```

---

## 8. í™˜ê²½ ë³€ìˆ˜ / Secrets

### Supabase Edge Functions
| Secret | ìš©ë„ |
|--------|------|
| `FIREBASE_SERVICE_ACCOUNT` | Firebase ì„œë¹„ìŠ¤ ê³„ì • JSON |
| `SUPABASE_URL` | ìë™ ì œê³µ |
| `SUPABASE_SERVICE_ROLE_KEY` | ìë™ ì œê³µ |

### GitHub Actions
| Secret | ìš©ë„ |
|--------|------|
| `SUPABASE_URL` | Edge Function í˜¸ì¶œ URL |
| `SUPABASE_ANON_KEY` | ì¸ì¦ |

---

## 9. í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´

```bash
# ìˆ˜ë™ í‘¸ì‹œ í…ŒìŠ¤íŠ¸
curl -X POST "https://enyxrgxixrnoazzgqyyd.supabase.co/functions/v1/send-fcm-push" \
  -H "Authorization: Bearer <ANON_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"userId": "<USER_ID>", "title": "í…ŒìŠ¤íŠ¸", "body": "ë‚´ìš©"}'

# ìŠ¤ë§ˆíŠ¸ ë„›ì§€ í…ŒìŠ¤íŠ¸
curl -X POST ".../send-smart-nudge" \
  -d '{"userId": "<USER_ID>", "forceType": "streak"}'

# ë°°ì¹˜ í…ŒìŠ¤íŠ¸
curl -X POST ".../send-batch-nudge" -d '{}'
```
