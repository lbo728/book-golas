# PRD: Smart Nudge System (지능형 독서 알림)

> **문서 상태:** Draft
> **작성일:** 2025-12-24
> **작성자:** Product Owner
> **관련 문서:** `FCM_STRATEGY.md`, `FCM_ARCHITECTURE.md`

---

## 1. 배경 및 목적 (Background & Objectives)

### 1.1 배경
기존의 단순 시간 기반(매일 저녁 8시) 알림은 사용자의 상황을 고려하지 않아 피로도를 높이고 앱 삭제로 이어질 위험이 있음. 사용자의 독서 상태와 심리를 반영한 '맥락적 알림'이 필요함.

### 1.2 목적
- **습관 형성:** 사용자의 생활 패턴에 맞춘 알림으로 독서 진입 장벽 완화.
- **리텐션 방어:** 작심삼일(3일 이탈) 사용자를 조기 감지하여 복귀 유도.
- **완독률 증대:** '남은 시간'을 제시하여 심리적 부담감을 낮춤(Time Currency).

### 1.3 성공 지표 (KPI)
- **알림 CTR (Click-Through Rate):** 5% 이상 목표.
- **Day 30 Retention:** 기능 도입 전 대비 10% 상승.
- **알림 수신 거부율:** 2% 미만 유지.

---

## 2. 유저 스토리 (User Stories)

1.  **[이탈 위기 유저]** 나는 3일 동안 책을 읽지 못했다. 죄책감이 들지만, 앱이 나를 비난하는 대신 따뜻하게 격려해주거나 다른 대안을 제시해주면 좋겠다.
2.  **[목표 지향 유저]** 나는 책을 빨리 다 읽고 싶다. 막연히 "읽으세요"보다 "10분만 읽으면 50페이지까지 갈 수 있다"는 구체적인 가이드를 원한다.
3.  **[습관 형성 유저]** 나는 출퇴근 시간에 짬을 내어 책을 읽고 싶다. 내가 지하철에 있을 때 딱 맞춰 알림이 오면 좋겠다.

---

## 3. 기능 상세 정의 (Functional Requirements)

### 3.1 발송 로직 및 우선순위 (Dispatch Logic)

시스템은 매일 정해진 시간(예: 08:00, 12:30, 20:00)에 배치(Batch)를 돌며 대상자를 추출한다. 한 유저에게 하루에 여러 알림이 가지 않도록 **우선순위**를 둔다.

**우선순위:**
1.  `Anti-Nudge` (침묵/대안 제시) - **최우선**
2.  `Retention` (3일 미접속)
3.  `Goal Achievement` (완독 임박)
4.  `Habit` (일상 루틴)

### 3.2 상세 시나리오별 명세

#### A. Retention (작심삼일 방지)
- **Target:** 마지막 독서 기록(Reading Session) 업데이트가 `72시간` 이상 `168시간(7일)` 미만인 유저.
- **Trigger:** 매일 20:00 체크.
- **Message Variable:** `[책제목]`, `[주인공이름/저자]`
- **Copy:**
  - "책갈피에 먼지가 쌓이고 있어요 😢 [책제목]이 3일째 기다리고 있습니다."

#### B. Time Currency (시간 화폐 - 목표 관리)
- **Target:** 현재 진행 중인 책이 있고, 오늘 독서 기록이 없는 유저.
- **Trigger:** 평일 22:00 (취침 전).
- **Logic:**
  - 유저의 `평균 독서 속도(Page per Minute)` 계산. (데이터 부족 시 기본값: 1페이지/2분)
  - `(목표 페이지 - 현재 페이지) / 속도` = 남은 시간 환산.
  - 남은 시간이 `30분` 미만인 경우 발송 (부담 없는 시간).
- **Copy:**
  - "잠들기 전 딱 **[N]분**만 투자하세요. 오늘 목표 분량을 채울 수 있어요! 🌙"

#### C. Anti-Nudge (침묵 프로토콜)
- **Target:** 최근 발송한 푸시 알림 3회 연속 `Click` 이벤트가 없는 유저.
- **Action:**
  - **D+1:** 알림 발송 중단 (Skip).
  - **D+3:** "책 변경 제안" 메시지 1회 발송 후 다시 카운트 리셋.
- **Copy:**
  - "요즘 [책제목] 진도가 안 나가시나요? 📚 잠시 덮어두고 가벼운 책으로 기분 전환해보세요."

---

## 4. 데이터 요구사항 (Data Requirements)

### 4.1 테이블 스키마 변경 (Supabase)

기존 `books` 및 `users` 테이블 외에 다음 데이터 추적이 필요함.

1.  **`push_logs` (푸시 발송 이력)**
    - `id` (UUID)
    - `user_id` (UUID)
    - `push_type` (Enum: RETENTION, TIME_CURRENCY, HABIT...)
    - `sent_at` (Timestamp)
    - `is_clicked` (Boolean, Default: false) - *클라이언트에서 클릭 시 업데이트*

2.  **`reading_statistics` (독서 통계 - 계산용)**
    - `user_id` (UUID)
    - `avg_page_per_minute` (Float) - *독서 세션 종료 시마다 갱신*

### 4.2 Edge Function 로직

- **함수명:** `send-smart-nudge` (기존 함수 고도화)
- **입력값:** 없음 (Cron으로 실행)
- **프로세스:**
  1. 전체 유저 중 FCM 토큰이 있는 유저 조회.
  2. 유저별 상태(마지막 독서일, 최근 푸시 반응, 현재 책 진행률) 조회.
  3. 우선순위 로직에 따라 알림 타입 결정.
  4. 메시지 구성 및 FCM 발송.
  5. `push_logs`에 발송 이력 저장.

---

## 5. UI/UX 요구사항 (Client Side)

### 5.1 알림 수신 시 동작
- **Deep Link:** 알림 클릭 시 단순히 앱을 여는 것이 아니라, 해당 책의 **[상세 페이지]** 또는 **[독서 타이머 화면]**으로 직행해야 함.
- **Payload 처리:**
  ```json
  {
    "route": "/book/detail",
    "book_id": "123-abc",
    "message_type": "time_currency"
  }
  ```

### 5.2 알림 설정 화면
- 단순 On/Off가 아니라 "방해 금지 시간" 설정이 가능해야 함 (Phase 2).
- 현재는 전체 알림 On/Off만 제공.

---

## 6. 개발 마일스톤 (Milestones)

### Phase 1: 기본 인프라 & Retention (1주차)
- `push_logs` 테이블 생성.
- `send-smart-nudge`에 "3일 미접속자" 필터링 로직 구현.
- 매일 20:00 Cron Job 등록.

### Phase 2: Time Currency & Deep Link (2주차)
- 독서 속도 계산 로직 구현 (`reading_sessions` 기반).
- "남은 시간" 계산 알고리즘 적용.
- Flutter 클라이언트에서 Deep Link 라우팅 처리.

### Phase 3: Anti-Nudge & 최적화 (3주차)
- 푸시 클릭 로그 수집 API 구현.
- 3회 미반응자 필터링 로직 적용.
- A/B 테스트 (문구 변경에 따른 CTR 비교).
