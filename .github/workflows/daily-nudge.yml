name: Daily Smart Nudge

# ë§¤ì¼ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 9ì‹œ (í•œêµ­ ì‹œê°„)ì— ìŠ¤ë§ˆíŠ¸ ë„›ì§€ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
# UTC ê¸°ì¤€: 00:00 (KST 09:00), 12:00 (KST 21:00)

on:
  schedule:
    - cron: '0 0 * * *'   # UTC 00:00 = KST 09:00 (ì˜¤ì „ ë„›ì§€)
    - cron: '0 12 * * *'  # UTC 12:00 = KST 21:00 (ì €ë… ë„›ì§€)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  send-batch-nudge:
    runs-on: ubuntu-latest

    steps:
      - name: Send Smart Nudge to All Users
        run: |
          echo "ğŸš€ Triggering batch smart nudge..."

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/send-batch-nudge" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "ğŸ“Š Response (HTTP $HTTP_CODE):"
          echo "$BODY" | jq . || echo "$BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Batch nudge completed successfully!"
          else
            echo "âŒ Batch nudge failed with HTTP $HTTP_CODE"
            exit 1
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
