name: Schema Validation

on:
  pull_request:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'

jobs:
  check-migrations:
    name: Validate Database Migrations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Check migration file naming
        run: |
          echo "Checking migration file naming conventions..."
          
          MIGRATION_DIR="supabase/migrations"
          ERRORS=0
          
          if [ -d "$MIGRATION_DIR" ]; then
            for file in "$MIGRATION_DIR"/*.sql; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                
                if ! [[ $filename =~ ^[0-9]{8}_[a-z_]+\.sql$ ]]; then
                  echo "::error file=$file::Invalid migration filename: $filename"
                  echo "  Expected format: YYYYMMDD_description.sql (lowercase, underscores)"
                  ERRORS=$((ERRORS + 1))
                fi
              fi
            done
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "::error::Found $ERRORS migration file(s) with invalid naming"
            exit 1
          fi
          
          echo "All migration files follow naming conventions"

      - name: Check for new migrations in PR
        id: check-new-migrations
        run: |
          echo "Checking for new migration files in this PR..."
          
          git fetch origin main
          NEW_MIGRATIONS=$(git diff --name-only origin/main...HEAD -- 'supabase/migrations/*.sql' || true)
          
          if [ -n "$NEW_MIGRATIONS" ]; then
            echo "new_migrations=true" >> $GITHUB_OUTPUT
            echo "::notice::New migrations detected:"
            echo "$NEW_MIGRATIONS"
            
            echo "### New Migrations" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$NEW_MIGRATIONS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "new_migrations=false" >> $GITHUB_OUTPUT
            echo "No new migrations in this PR"
          fi

      - name: Migration safety warning
        if: steps.check-new-migrations.outputs.new_migrations == 'true'
        run: |
          echo "::warning::This PR contains database migrations!"
          echo ""
          echo "IMPORTANT: Before merging to main, ensure:"
          echo "1. Migrations have been applied to PRODUCTION Supabase (enyxrgxixrnoazzgqyyd)"
          echo "2. The PR checklist in the description is complete"
          echo "3. Rollback SQL is prepared if needed"
          echo ""
          
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          
          ## ⚠️ Database Migration Warning
          
          This PR contains database schema changes. **Before merging:**
          
          | Check | Status |
          |-------|--------|
          | Migrations applied to **Dev DB** | ☐ |
          | Migrations applied to **Prod DB** | ☐ |
          | Rollback SQL prepared | ☐ |
          | Data migration plan (if needed) | ☐ |
          
          ### Supabase Project References
          - **Dev**: `reoiqefoymdsqzpbouxi`
          - **Prod**: `enyxrgxixrnoazzgqyyd`
          
          EOF

      - name: Block dangerous operations (CRITICAL)
        if: steps.check-new-migrations.outputs.new_migrations == 'true'
        run: |
          echo "Checking for dangerous SQL operations..."
          
          git fetch origin main
          NEW_MIGRATIONS=$(git diff --name-only origin/main...HEAD -- 'supabase/migrations/*.sql' || true)
          
          BLOCKED=0
          
          for file in $NEW_MIGRATIONS; do
            if [ -f "$file" ]; then
              echo "Scanning $file..."
              
              # BLOCKED: These operations require manual review and approval
              if grep -qi "DROP TABLE" "$file"; then
                echo "::error file=$file::❌ BLOCKED: DROP TABLE detected"
                echo "  → 테이블 삭제는 CI에서 차단됩니다. 수동 승인 필요."
                BLOCKED=$((BLOCKED + 1))
              fi
              
              if grep -qi "DROP COLUMN" "$file"; then
                echo "::error file=$file::❌ BLOCKED: DROP COLUMN detected"
                echo "  → 컬럼 삭제는 CI에서 차단됩니다. 기존 데이터 손실 위험."
                BLOCKED=$((BLOCKED + 1))
              fi
              
              if grep -qi "TRUNCATE" "$file"; then
                echo "::error file=$file::❌ BLOCKED: TRUNCATE detected"
                echo "  → 데이터 전체 삭제는 절대 금지입니다."
                BLOCKED=$((BLOCKED + 1))
              fi
              
              if grep -qi "DELETE FROM.*WHERE" "$file" && ! grep -qi "-- safe-delete" "$file"; then
                echo "::error file=$file::❌ BLOCKED: Mass DELETE detected"
                echo "  → 대량 삭제는 CI에서 차단됩니다. '-- safe-delete' 주석으로 명시적 승인 필요."
                BLOCKED=$((BLOCKED + 1))
              fi
              
              # WARNING: These need attention but don't block
              if grep -qi "ALTER.*TYPE" "$file"; then
                echo "::warning file=$file::⚠️ WARNING: Column type change detected"
                echo "  → 데이터 호환성 확인 필요. 기존 데이터가 변환 가능한지 검증하세요."
              fi
              
              if grep -qi "NOT NULL" "$file" && ! grep -qi "DEFAULT" "$file"; then
                echo "::warning file=$file::⚠️ WARNING: NOT NULL without DEFAULT"
                echo "  → 기존 데이터에 NULL이 있으면 마이그레이션 실패할 수 있습니다."
              fi
              
              if grep -qi "RENAME" "$file"; then
                echo "::warning file=$file::⚠️ WARNING: RENAME detected"
                echo "  → 이름 변경 시 코드에서 해당 이름을 참조하는 곳도 함께 수정하세요."
              fi
            fi
          done
          
          if [ $BLOCKED -gt 0 ]; then
            echo ""
            echo "========================================"
            echo "❌ $BLOCKED dangerous operation(s) blocked"
            echo "========================================"
            echo ""
            echo "파괴적 변경은 CI에서 자동 실행되지 않습니다."
            echo ""
            echo "해결 방법:"
            echo "1. Supabase 대시보드에서 수동으로 실행"
            echo "2. 또는 안전한 3단계 삭제 패턴 사용:"
            echo "   - Phase 1: 코드에서 사용 중단"
            echo "   - Phase 2: 컬럼명 변경 (_deprecated_xxx)"
            echo "   - Phase 3: 2주 후 실제 삭제"
            echo ""
            exit 1
          fi
          
          echo "✅ SQL validation complete - no dangerous operations detected"

  check-edge-functions:
    name: Validate Edge Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for new Edge Functions in PR
        id: check-functions
        run: |
          git fetch origin main
          NEW_FUNCTIONS=$(git diff --name-only origin/main...HEAD -- 'supabase/functions/**' || true)
          
          if [ -n "$NEW_FUNCTIONS" ]; then
            echo "new_functions=true" >> $GITHUB_OUTPUT
            echo "::notice::Edge Function changes detected:"
            echo "$NEW_FUNCTIONS"
            
            echo "### Edge Function Changes" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$NEW_FUNCTIONS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "new_functions=false" >> $GITHUB_OUTPUT
          fi

      - name: Edge Function deployment warning
        if: steps.check-functions.outputs.new_functions == 'true'
        run: |
          echo "::warning::This PR contains Edge Function changes!"
          echo ""
          echo "Ensure Edge Functions are deployed to PRODUCTION before merging."
          echo ""
          
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          
          ## ⚠️ Edge Function Changes
          
          Ensure functions are deployed to production:
          
          ```bash
          supabase link --project-ref enyxrgxixrnoazzgqyyd
          supabase functions deploy <function-name>
          ```
          
          EOF
